<MapUi::Popup @activeFeature={{this.activeFeature}} @close={{this.clearActiveFeature}} @closeKey={{this.clearActiveFeatureKey}} />
<LeafletMap
  @lat={{@project.centerLat}}
  @lng={{@project.centerLng}}
  @zoom={{@project.zoomLevel}}
  @onLoad={{this.initMap}}
  @onMoveend={{this.captureBounds}}
  @onZoomend={{this.captureBounds}}
  @onResize={{this.addZoomControl}}
  {{on 'keyup' this.clearActiveFeatureKey}}
as |layers|>

{{#if this.map}}
  {{#each @project._defaultBaseMap.layers as |layer index|}}
    <layers.tile
      @url={{layer}}
      @zIndex={{index}}
      @className={{concat "base-" @project._defaultBaseMap.label}}
      @onLoading={{fn this.baseChange @project._defaultBaseMap}}
      @onLoad={{perform this.baseChanged}}
    />
  {{/each}}
  {{#if @project.hasRasters}}
    {{#each @project.sortedRasters as |raster|}}
      <layers.wmsTile
        @url={{raster.rasterLayer.url}}
        @layers={{raster.rasterLayer.layers}}
        @format="image/png"
        @transparent={{true}}
        @zIndex={{raster.position}}
        @opacity={{raster.opacityTenths}}
        @className={{concat "raster-" raster.rasterLayer.name}}
        @onLoad={{fn this.rasterAdded raster.rasterLayer}}
      />
    {{/each}}
  {{/if}}

  {{#each @project.vectors as |v|}}
    {{#each v.vectorLayer.vectorFeature as |vf|}}
    {{/each}}
  {{/each}}

  {{#if @project.hasVectors}}
    {{#each @project.reverseVectors as |vector|}}
      {{#if vector.show }}
        {{#if (eq vector.vectorLayer.dataFormat 'pbf')}}
          <layers.vectorTile
            @url={{concat vector.vectorLayer.institution.geoserver "/gwc/service/tms/1.0.0/" vector.vectorLayer.workspace ":" vector.vectorLayer.name "@EPSG:900913@pbf/{z}/{x}/{-y}.pbf"}}
            @zIndex="600"
            @idProperty={{vector.vectorLayer.propertyId}}
            @styleFeatures={{fn this.styleVectorTile vector vector.colorMap}}
            @layerName={{vector.vectorLayer.name}}
            @onClick={{fn this.activateVT vector}}
          />
        {{else}}
          {{#each vector.vectorLayer.vectorFeatures as |feature|}}
            <layers.geojson
              @geoJSON={{feature.geojson}}
              @onEachFeature={{fn this.onEachFeature feature vector.color}}
              @pointToLayer={{fn this.addMarker feature}}
              @color={{vector-color vector feature this.dataColors}}
              @fillColor={{vector-color vector feature this.dataColors}}
              @fillOpacity={{feature.opacity}}
              @weight={{feature.weight}}
              @className={{concat "shape-" vector.vectorLayer.name}}
              @onAdd={{fn this.geoJsonAdded vector.vectorLayer}}
            />
          {{/each}}
        {{/if}}
      {{/if}}
    {{/each}}
  {{/if}}
{{/if}}
</LeafletMap>

<div class="testing" id="map-component">
  <span id="center">
    {{@project.centerLat}} : {{@project.centerLng}}
  </span>
  <span id="zoom">
    {{@project.zoomLevel}}
  </span>
</div>